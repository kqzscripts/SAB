-- Kqz Utility Hub (2025 BYPASS EDITION)
-- Features: Set Checkpoint, Auto TP, Desync
-- Optimized for: Steal a Brainrot / Bunni.lol
-- UI: Grey / Dark Grey / White
-- Anti-Cheat Bypass Enabled (2025 Optimized)

local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local TeleportService = game:GetService("TeleportService")
local Lighting = game:GetService("Lighting")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer

-- ================= STATE =================
local State = {
    SavedPos = nil,
    AutoTP = false,
    CheckpointVisual = nil,
    DesyncEnabled = false,
    DesyncConnection = nil,
    AutoTPConnection = nil
}

-- ================= GUI SETUP =================
-- Cleanup
local existing = CoreGui:FindFirstChild("KqzUtilityHub")
if existing then existing:Destroy() end

local workspace = game:GetService("Workspace")
local oldIndicator = workspace:FindFirstChild("KqzExploitz_Checkpoint")
if oldIndicator then oldIndicator:Destroy() end

local gui = Instance.new("ScreenGui")
gui.Name = "KqzUtilityHub"
gui.Parent = CoreGui
gui.DisplayOrder = 999999
gui.ResetOnSpawn = false

pcall(function() gui.IgnoreGuiInset = true end)

local Main = Instance.new("Frame", gui)
Main.Name = "MainFrame"
Main.Size = UDim2.new(0, 330, 0, 320)
Main.Position = UDim2.fromScale(0.5, 0.5)
Main.AnchorPoint = Vector2.new(0.5, 0.5)
Main.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Main.Active = true
Instance.new("UICorner", Main)

-- Dragging Logic
do
    local dragging, dragStart, startPos
    Main.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = i.Position
            startPos = Main.Position
            i.Changed:Connect(function()
                if i.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    UIS.InputChanged:Connect(function(i)
        if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
            local delta = i.Position - dragStart
            Main.Position = startPos + UDim2.fromOffset(delta.X, delta.Y)
        end
    end)
end

-- Layout Constants
local TITLE_HEIGHT = 35
local FOOTER_HEIGHT = 65

-- Title Bar
local TitleBar = Instance.new("Frame", Main)
TitleBar.Size = UDim2.new(1, 0, 0, TITLE_HEIGHT)
TitleBar.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
Instance.new("UICorner", TitleBar)

local TitleText = Instance.new("TextLabel", TitleBar)
TitleText.Size = UDim2.new(1, -70, 1, 0)
TitleText.Position = UDim2.new(0, 12, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.Text = "Kqz Utility Hub"
TitleText.Font = Enum.Font.GothamBold
TitleText.TextSize = 16
TitleText.TextColor3 = Color3.new(1, 1, 1)
TitleText.TextXAlignment = Enum.TextXAlignment.Left

-- Content Area (Scrolling)
local Content = Instance.new("ScrollingFrame", Main)
Content.Name = "ContentFrame"
Content.Position = UDim2.new(0, 10, 0, TITLE_HEIGHT + 10)
Content.Size = UDim2.new(1, -20, 1, -(TITLE_HEIGHT + FOOTER_HEIGHT + 20))
Content.BackgroundTransparency = 1
Content.CanvasSize = UDim2.new()
Content.AutomaticCanvasSize = Enum.AutomaticCanvasSize.Y
Content.ScrollBarThickness = 3
Content.ZIndex = 5

local Layout = Instance.new("UIListLayout", Content)
Layout.Padding = UDim.new(0, 8)

-- Footer (Player Info)
local Footer = Instance.new("Frame", Main)
Footer.Name = "FooterFrame"
Footer.Size = UDim2.new(1, -20, 0, FOOTER_HEIGHT)
Footer.Position = UDim2.new(0, 10, 1, -(FOOTER_HEIGHT + 5))
Footer.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
Footer.ZIndex = 2
Instance.new("UICorner", Footer)

local UserIDLabel = Instance.new("TextLabel", Footer)
UserIDLabel.Size = UDim2.new(1, 0, 1, 0)
UserIDLabel.BackgroundTransparency = 1
UserIDLabel.Text = "UserId: " .. player.UserId
UserIDLabel.Font = Enum.Font.Gotham
UserIDLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
UserIDLabel.TextSize = 14

-- ================= UI HELPERS =================
local function CreateButton(text, callback)
    local b = Instance.new("TextButton", Content)
    b.Size = UDim2.new(1, 0, 0, 38)
    b.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
    b.Text = text
    b.Font = Enum.Font.GothamSemibold
    b.TextSize = 14
    b.TextColor3 = Color3.new(1, 1, 1)
    b.ZIndex = 6
    Instance.new("UICorner", b)
    b.MouseButton1Click:Connect(function() callback(b) end)
    return b
end

local function CreateToggle(text, callback)
    local on = false
    local b = CreateButton(text .. " : OFF", function(btn)
        on = not on
        btn.Text = text .. " : " .. (on and "ON" or "OFF")
        TweenService:Create(btn, TweenInfo.new(0.2), {
            BackgroundColor3 = on and Color3.fromRGB(80, 80, 80) or Color3.fromRGB(55, 55, 55)
        }):Play()
        callback(on)
    end)
    return b
end

-- ================= BYPASS HELPERS =================
local function GetCarpet()
    local char = player.Character
    if not char then return end
    local carpet = char:FindFirstChild("Flying Carpet") or player.Backpack:FindFirstChild("Flying Carpet")
    return carpet
end

local function CreateVisual(pos)
    if State.CheckpointVisual then State.CheckpointVisual:Destroy() end
    local char = player.Character
    if not char then return end
    local hum = char:FindFirstChild("Humanoid")
    local height = (hum and hum.HipHeight + 3) or 6

    local indicator = Instance.new("Part")
    indicator.Name = "KqzExploitz_Checkpoint"
    indicator.Size = Vector3.new(4, height, 4)
    indicator.Position = pos
    indicator.Anchored = true
    indicator.CanCollide = false
    indicator.Transparency = 0.5
    indicator.Color = Color3.fromRGB(200, 200, 200)
    indicator.Material = Enum.Material.SmoothPlastic
    indicator.Parent = workspace
    
    local mesh = Instance.new("SpecialMesh")
    mesh.MeshType = Enum.MeshType.Brick
    mesh.Parent = indicator

    State.CheckpointVisual = indicator
end

-- ================= FEATURES =================

-- Set Checkpoint
CreateButton("Set Checkpoint", function()
    local char = player.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if hrp then
        State.SavedPos = hrp.Position
        CreateVisual(State.SavedPos)
        
        -- Anti-Die / Desync Jitter
        if State.DesyncConnection then State.DesyncConnection:Disconnect() end
        State.DesyncConnection = RunService.Heartbeat:Connect(function()
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                player.Character.HumanoidRootPart.Velocity = Vector3.new(0, 0.05, 0)
            end
        end)
    end
end)

-- Auto TP
CreateToggle("Auto TP", function(v)
    State.AutoTP = v
    if v then
        if State.AutoTPConnection then State.AutoTPConnection:Disconnect() end
        State.AutoTPConnection = task.spawn(function()
            while State.AutoTP do
                local char = player.Character
                local hrp = char and char:FindFirstChild("HumanoidRootPart")
                if hrp and State.SavedPos then
                    -- Detect steal (holding tool that isn't carpet)
                    local tool = char:FindFirstChildOfClass("Tool")
                    if tool and tool.Name ~= "Flying Carpet" then
                        local carpet = GetCarpet()
                        if carpet then
                            -- Anchor with carpet
                            carpet.Parent = char
                            task.wait(0.05)
                            
                            -- Instant teleport bypass
                            hrp.CFrame = CFrame.new(State.SavedPos)
                            hrp.Velocity = Vector3.new(0, 0, 0)
                        end
                    end
                end
                task.wait(0.1)
            end
        end)
    else
        if State.AutoTPConnection then 
            State.AutoTPConnection:Disconnect() 
            State.AutoTPConnection = nil
        end
    end
end)

-- Desync
CreateToggle("Desync", function(v)
    State.DesyncEnabled = v
    if v then
        -- Start desync jitter when enabled
        if State.DesyncConnection then State.DesyncConnection:Disconnect() end
        State.DesyncConnection = RunService.Heartbeat:Connect(function()
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                player.Character.HumanoidRootPart.Velocity = Vector3.new(0, 0.05, 0)
            end
        end)
    else
        -- Stop desync jitter when disabled (unless checkpoint is set)
        if not State.SavedPos and State.DesyncConnection then
            State.DesyncConnection:Disconnect()
            State.DesyncConnection = nil
        end
    end
end)

-- FPS Boost
CreateButton("FPS Boost", function()
    for _, v in ipairs(Lighting:GetChildren()) do
        if v:IsA("PostEffect") then v.Enabled = false end
    end
end)

-- Rejoin
CreateButton("Rejoin", function()
    TeleportService:Teleport(game.PlaceId, player)
end)

-- ================= TOGGLE KEYBIND =================
UIS.InputBegan:Connect(function(input, gpe)
    if not gpe and input.KeyCode == Enum.KeyCode.RightShift then
        gui.Enabled = not gui.Enabled
    end
end)

print("[KqzHub] Final Bypass Hub Initialized")
