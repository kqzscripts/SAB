-- KqzExploitz
-- Features: Set Checkpoint, Auto TP, Desync
-- UI: Grey / Dark Grey / White
-- Anti-Cheat Bypass Enabled (2025 Optimized)

local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer

-- ================= STATE =================
local SavedCheckpoint = nil
local DesyncEnabled = false
local ServerPositionIndicator = nil
local DesyncConnection = nil
local AutoTPActive = false
local AutoTPConnection = nil

-- ================= CLEANUP =================
local existing = CoreGui:FindFirstChild("KqzExploitzUI")
if existing then existing:Destroy() end

local workspace = game:GetService("Workspace")
local oldIndicator = workspace:FindFirstChild("KqzExploitz_Checkpoint")
if oldIndicator then oldIndicator:Destroy() end

-- ================= GUI =================
local gui = Instance.new("ScreenGui")
gui.Name = "KqzExploitzUI"
gui.ResetOnSpawn = false
gui.Parent = CoreGui
gui.DisplayOrder = 999999

pcall(function() gui.IgnoreGuiInset = true end)

local Main = Instance.new("Frame", gui)
Main.Size = UDim2.new(0, 320, 0, 310)
Main.Position = UDim2.fromScale(0.5, 0.5)
Main.AnchorPoint = Vector2.new(0.5, 0.5)
Main.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
Main.Active = true
Instance.new("UICorner", Main)

local Minimized = false

-- ================= DRAG =================
do
    local dragging, startPos, startInput
    Main.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            startInput = i.Position
            startPos = Main.Position
            i.Changed:Connect(function()
                if i.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    UIS.InputChanged:Connect(function(i)
        if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
            local delta = i.Position - startInput
            Main.Position = startPos + UDim2.fromOffset(delta.X, delta.Y)
        end
    end)
end

-- ================= TITLE BAR =================
local Title = Instance.new("Frame", Main)
Title.Size = UDim2.new(1, 0, 0, 36)
Title.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
Instance.new("UICorner", Title)

local TitleText = Instance.new("TextLabel", Title)
TitleText.Size = UDim2.new(1, -100, 1, 0)
TitleText.Position = UDim2.new(0, 12, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.Text = "KqzExploitz"
TitleText.Font = Enum.Font.GothamBold
TitleText.TextSize = 16
TitleText.TextColor3 = Color3.new(1, 1, 1)
TitleText.TextXAlignment = Enum.TextXAlignment.Left

local Minimize = Instance.new("TextButton", Title)
Minimize.Size = UDim2.new(0, 22, 0, 22)
Minimize.Position = UDim2.new(1, -56, 0, 7)
Minimize.Text = "_"
Minimize.Font = Enum.Font.GothamBold
Minimize.TextSize = 14
Minimize.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
Minimize.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", Minimize)

local Content = Instance.new("Frame", Main)
Content.Position = UDim2.new(0, 10, 0, 50)
Content.Size = UDim2.new(1, -20, 1, -60)
Content.BackgroundTransparency = 1
Content.Visible = true

Minimize.MouseButton1Click:Connect(function()
    Minimized = not Minimized
    if Minimized then
        Main.Size = UDim2.new(0, 320, 0, 36)
        Content.Visible = false
    else
        Main.Size = UDim2.new(0, 320, 0, 310)
        Content.Visible = true
    end
end)

local Close = Instance.new("TextButton", Title)
Close.Size = UDim2.new(0, 22, 0, 22)
Close.Position = UDim2.new(1, -28, 0, 7)
Close.Text = "X"
Close.Font = Enum.Font.GothamBold
Close.TextSize = 14
Close.BackgroundColor3 = Color3.fromRGB(170, 60, 60)
Close.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", Close)

Close.MouseButton1Click:Connect(function()
    gui:Destroy()
    if ServerPositionIndicator then ServerPositionIndicator:Destroy() end
end)

local layout = Instance.new("UIListLayout", Content)
layout.Padding = UDim.new(0, 10)

-- ================= HELPERS =================
local function Button(text, callback)
    local b = Instance.new("TextButton", Content)
    b.Size = UDim2.new(1, 0, 0, 42)
    b.Text = text
    b.Font = Enum.Font.GothamSemibold
    b.TextSize = 14
    b.TextColor3 = Color3.new(1,1,1)
    b.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    Instance.new("UICorner", b)
    b.MouseButton1Click:Connect(callback)
    return b
end

local function CreateToggle(text, callback)
    local enabled = false
    local b = Button(text .. ": OFF", function()
        enabled = not enabled
        callback(enabled)
    end)
    return b, function(state)
        enabled = state
        b.Text = text .. ": " .. (enabled and "ON" or "OFF")
        b.BackgroundColor3 = enabled and Color3.fromRGB(85, 85, 85) or Color3.fromRGB(60, 60, 60)
    end
end

-- ================= BYPASS HELPERS =================
local function GetCarpet()
    local char = player.Character
    if not char then return end
    local carpet = char:FindFirstChild("Flying Carpet") or player.Backpack:FindFirstChild("Flying Carpet")
    return carpet
end

local function CreateVisual(pos)
    if ServerPositionIndicator then ServerPositionIndicator:Destroy() end
    local char = player.Character
    if not char then return end
    local hum = char:FindFirstChild("Humanoid")
    local height = (hum and hum.HipHeight + 3) or 6

    local indicator = Instance.new("Part")
    indicator.Name = "KqzExploitz_Checkpoint"
    indicator.Size = Vector3.new(4, height, 4)
    indicator.Position = pos
    indicator.Anchored = true
    indicator.CanCollide = false
    indicator.Transparency = 0.5
    indicator.Color = Color3.fromRGB(200, 200, 200)
    indicator.Material = Enum.Material.SmoothPlastic
    indicator.Parent = workspace
    
    local mesh = Instance.new("SpecialMesh")
    mesh.MeshType = Enum.MeshType.Brick
    mesh.Parent = indicator

    ServerPositionIndicator = indicator
end

-- ================= FEATURES =================

-- SET CHECKPOINT
local setBtn = Button("Set Checkpoint", function()
    local char = player.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if hrp then
        SavedCheckpoint = hrp.Position
        CreateVisual(SavedCheckpoint)
        
        -- Anti-Die / Desync Jitter
        if DesyncConnection then DesyncConnection:Disconnect() end
        DesyncConnection = RunService.Heartbeat:Connect(function()
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                player.Character.HumanoidRootPart.Velocity = Vector3.new(0, 0.05, 0)
            end
        end)
    end
end)

-- AUTO TP
local autoTpBtn, updateAutoTp = CreateToggle("Auto TP", function(s)
    AutoTPActive = s
    updateAutoTp(s)
    if s then
        task.spawn(function()
            while AutoTPActive do
                local char = player.Character
                local hrp = char and char:FindFirstChild("HumanoidRootPart")
                if hrp and SavedCheckpoint then
                    -- Detect steal (holding tool that isn't carpet)
                    local tool = char:FindFirstChildOfClass("Tool")
                    if tool and tool.Name ~= "Flying Carpet" then
                        local carpet = GetCarpet()
                        if carpet then
                            -- Anchor with carpet
                            carpet.Parent = char
                            task.wait(0.05)
                            
                            -- Instant teleport bypass
                            hrp.CFrame = CFrame.new(SavedCheckpoint)
                            hrp.Velocity = Vector3.new(0, 0, 0)
                        end
                    end
                end
                task.wait(0.1)
            end
        end)
    end
end)

-- DESYNC (Visual Toggle only as per request to keep it)
local desyncBtn, updateDesync = CreateToggle("Desync", function(s)
    DesyncEnabled = s
    updateDesync(s)
end)

-- ================= KEYBIND =================
UIS.InputBegan:Connect(function(input, gpe)
    if not gpe and input.KeyCode == Enum.KeyCode.RightShift then
        gui.Enabled = not gui.Enabled
    end
end)

print("[KqzExploitz] Hub Loaded Successfully")
