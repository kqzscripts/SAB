-- Kqz Utility Hub (2025 BYPASS EDITION)
-- Features: Set Checkpoint, Auto TP
-- Optimized for: Steal a Brainrot / Bunni.lol

local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local TeleportService = game:GetService("TeleportService")
local Lighting = game:GetService("Lighting")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer

-- ================= STATE =================
local State = {
    SavedPos = nil,
    AutoTP = false,
    CheckpointVisual = nil
}

-- ================= GUI SETUP =================
-- Cleanup
local existing = CoreGui:FindFirstChild("KqzUtilityHub")
if existing then existing:Destroy() end

local gui = Instance.new("ScreenGui")
gui.Name = "KqzUtilityHub"
gui.Parent = CoreGui
gui.DisplayOrder = 999999
gui.ResetOnSpawn = false

pcall(function() gui.IgnoreGuiInset = true end)

local Main = Instance.new("Frame", gui)
Main.Name = "MainFrame"
Main.Size = UDim2.new(0, 330, 0, 320)
Main.Position = UDim2.fromScale(0.5, 0.5)
Main.AnchorPoint = Vector2.new(0.5, 0.5)
Main.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Main.Active = true
Instance.new("UICorner", Main)

-- Dragging Logic
do
    local dragging, dragStart, startPos
    Main.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = i.Position
            startPos = Main.Position
            i.Changed:Connect(function()
                if i.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    UIS.InputChanged:Connect(function(i)
        if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
            local delta = i.Position - dragStart
            Main.Position = startPos + UDim2.fromOffset(delta.X, delta.Y)
        end
    end)
end

-- Layout Constants
local TITLE_HEIGHT = 35
local FOOTER_HEIGHT = 65

-- Title Bar
local TitleBar = Instance.new("Frame", Main)
TitleBar.Size = UDim2.new(1, 0, 0, TITLE_HEIGHT)
TitleBar.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
Instance.new("UICorner", TitleBar)

local TitleText = Instance.new("TextLabel", TitleBar)
TitleText.Size = UDim2.new(1, -70, 1, 0)
TitleText.Position = UDim2.new(0, 12, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.Text = "Kqz Utility Hub"
TitleText.Font = Enum.Font.GothamBold
TitleText.TextSize = 16
TitleText.TextColor3 = Color3.new(1, 1, 1)
TitleText.TextXAlignment = Enum.TextXAlignment.Left

-- Content Area (Scrolling)
local Content = Instance.new("ScrollingFrame", Main)
Content.Name = "ContentFrame"
Content.Position = UDim2.new(0, 10, 0, TITLE_HEIGHT + 10)
Content.Size = UDim2.new(1, -20, 1, -(TITLE_HEIGHT + FOOTER_HEIGHT + 20))
Content.BackgroundTransparency = 1
Content.CanvasSize = UDim2.new()
Content.AutomaticCanvasSize = Enum.AutomaticCanvasSize.Y
Content.ScrollBarThickness = 3
Content.ZIndex = 5

local Layout = Instance.new("UIListLayout", Content)
Layout.Padding = UDim.new(0, 8)

-- Footer (Player Info)
local Footer = Instance.new("Frame", Main)
Footer.Name = "FooterFrame"
Footer.Size = UDim2.new(1, -20, 0, FOOTER_HEIGHT)
Footer.Position = UDim2.new(0, 10, 1, -(FOOTER_HEIGHT + 5))
Footer.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
Footer.ZIndex = 2
Instance.new("UICorner", Footer)

local UserIDLabel = Instance.new("TextLabel", Footer)
UserIDLabel.Size = UDim2.new(1, 0, 1, 0)
UserIDLabel.BackgroundTransparency = 1
UserIDLabel.Text = "UserId: " .. player.UserId
UserIDLabel.Font = Enum.Font.Gotham
UserIDLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
UserIDLabel.TextSize = 14

-- ================= UI HELPERS =================
local function CreateButton(text, callback)
    local b = Instance.new("TextButton", Content)
    b.Size = UDim2.new(1, 0, 0, 38)
    b.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
    b.Text = text
    b.Font = Enum.Font.GothamSemibold
    b.TextSize = 14
    b.TextColor3 = Color3.new(1, 1, 1)
    b.ZIndex = 6
    Instance.new("UICorner", b)
    b.MouseButton1Click:Connect(function() callback(b) end)
    return b
end

local function CreateToggle(text, callback)
    local on = false
    local b = CreateButton(text .. " : OFF", function(btn)
        on = not on
        btn.Text = text .. " : " .. (on and "ON" or "OFF")
        TweenService:Create(btn, TweenInfo.new(0.2), {
            BackgroundColor3 = on and Color3.fromRGB(80, 80, 80) or Color3.fromRGB(55, 55, 55)
        }):Play()
        callback(on)
    end)
    return b
end

-- ================= FEATURES =================

-- Set Checkpoint
CreateButton("Set Checkpoint", function()
    local char = player.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        local hrp = char.HumanoidRootPart
        State.SavedPos = hrp.Position
        
        -- Create/Update Visual
        if State.CheckpointVisual then State.CheckpointVisual:Destroy() end
        
        local visual = Instance.new("Part")
        visual.Name = "CheckpointVisual"
        visual.Size = Vector3.new(2, 6, 2)
        visual.Position = State.SavedPos
        visual.Color = Color3.fromRGB(200, 200, 200) -- Light Grey
        visual.Transparency = 0.5
        visual.Anchored = true
        visual.CanCollide = false
        visual.Parent = game.Workspace
        
        local mesh = Instance.new("SpecialMesh")
        mesh.MeshType = Enum.MeshType.Brick
        mesh.Scale = Vector3.new(1, 1, 1)
        mesh.Parent = visual
        
        local corner = Instance.new("UICorner") -- This doesn't work on Parts, use Bevel or specialized mesh scale if needed
        -- Note: UICorner is for UI. For Parts, we use a block with SpecialMesh or just a Part.
        -- To get rounded edges on a part, we usually use a MeshPart or Bevel. 
        -- For simplicity and exploit standard, we'll use a Neon/Smooth part.
        visual.Material = Enum.Material.SmoothPlastic
        
        State.CheckpointVisual = visual
        
        -- Anti-Die / Desync Jitter (Integrated into Checkpoint logic)
        task.spawn(function()
            local connection
            connection = RunService.Heartbeat:Connect(function()
                if not State.SavedPos then connection:Disconnect() return end
                local c = player.Character
                if c and c:FindFirstChild("HumanoidRootPart") then
                    local h = c.HumanoidRootPart
                    -- Subtle jitter to prevent server-side death/checks while stationary
                    h.Velocity = Vector3.new(0, 0.05, 0)
                end
            end)
        end)
    end
end)

-- Auto TP
CreateToggle("Auto TP", function(v)
    State.AutoTP = v
    if v then
        task.spawn(function()
            while State.AutoTP do
                local char = player.Character
                if char and char:FindFirstChild("HumanoidRootPart") and State.SavedPos then
                    -- Check if holding object (Tool)
                    local tool = char:FindFirstChildOfClass("Tool")
                    if tool and tool.Name ~= "Flying Carpet" then
                        local backpack = player.Backpack
                        local carpet = backpack:FindFirstChild("Flying Carpet") or char:FindFirstChild("Flying Carpet")
                        
                        if carpet then
                            -- Equip carpet for anchor
                            if carpet.Parent == backpack then
                                carpet.Parent = char
                            end
                            
                            -- Instant Teleport while carpet is used as fly anchor
                            task.wait(0.05)
                            char.HumanoidRootPart.CFrame = CFrame.new(State.SavedPos)
                            
                            -- Physics bypass to prevent break/pullback
                            char.HumanoidRootPart.Velocity = Vector3.new(0, 0, 0)
                        end
                    end
                end
                task.wait(0.1)
            end
        end)
    end
end)

CreateButton("FPS Boost", function()
    for _, v in ipairs(Lighting:GetChildren()) do
        if v:IsA("PostEffect") then v.Enabled = false end
    end
end)

CreateButton("Rejoin", function()
    TeleportService:Teleport(game.PlaceId, player)
end)

-- ================= TOGGLE KEYBIND =================
UIS.InputBegan:Connect(function(input, gpe)
    if not gpe and input.KeyCode == Enum.KeyCode.RightShift then
        gui.Enabled = not gui.Enabled
    end
end)

print("[KqzHub] Final Bypass Hub Initialized")
