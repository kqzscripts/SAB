--[[ 
    Kqz Utility Hub (FIXED & UPGRADED)
    Game: Steal a Brainrot / Bunni.lol
    Status: Working Client-Side Features
]]

-- ================= SERVICES =================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local TeleportService = game:GetService("TeleportService")
local Lighting = game:GetService("Lighting")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer

-- ================= STATE =================
local State = {
    WalkSpeed = false,
    JumpPower = false,
    SavedCFrame = nil,
    Alive = false
}

-- ================= CHARACTER HANDLING =================
local character, humanoid, hrp

local function SetupCharacter(char)
    character = char
    humanoid = char:WaitForChild("Humanoid", 5)
    hrp = char:WaitForChild("HumanoidRootPart", 5)
    State.Alive = humanoid ~= nil and hrp ~= nil
end

if player.Character then
    SetupCharacter(player.Character)
end

player.CharacterAdded:Connect(SetupCharacter)

-- ================= CLEANUP GUI =================
local old = CoreGui:FindFirstChild("KqzUtilityHub")
if old then old:Destroy() end

-- ================= GUI =================
local gui = Instance.new("ScreenGui")
gui.Name = "KqzUtilityHub"
gui.ResetOnSpawn = false
gui.Parent = CoreGui

local Main = Instance.new("Frame", gui)
Main.Size = UDim2.new(0, 330, 0, 320)
Main.Position = UDim2.fromScale(0.5, 0.5)
Main.AnchorPoint = Vector2.new(0.5, 0.5)
Main.BackgroundColor3 = Color3.fromRGB(30,30,30)
Main.Active = true
Instance.new("UICorner", Main)

-- Drag
do
    local dragging, start, pos
    Main.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            start = i.Position
            pos = Main.Position
            i.Changed:Connect(function()
                if i.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    UIS.InputChanged:Connect(function(i)
        if dragging then
            local delta = i.Position - start
            Main.Position = pos + UDim2.fromOffset(delta.X, delta.Y)
        end
    end)
end

-- ================= CONTENT =================
local Content = Instance.new("Frame", Main)
Content.Position = UDim2.new(0,10,0,10)
Content.Size = UDim2.new(1,-20,1,-20)
Content.BackgroundTransparency = 1

local layout = Instance.new("UIListLayout", Content)
layout.Padding = UDim.new(0,8)

local function Button(text, callback)
    local b = Instance.new("TextButton", Content)
    b.Size = UDim2.new(1,0,0,38)
    b.Text = text
    b.BackgroundColor3 = Color3.fromRGB(55,55,55)
    b.TextColor3 = Color3.new(1,1,1)
    b.Font = Enum.Font.GothamBold
    b.TextSize = 14
    Instance.new("UICorner", b)
    b.MouseButton1Click:Connect(callback)
    return b
end

local function Toggle(name, onToggle)
    local enabled = false
    local b
    b = Button(name .. ": OFF", function()
        enabled = not enabled
        b.Text = name .. ": " .. (enabled and "ON" or "OFF")
        b.BackgroundColor3 = enabled and Color3.fromRGB(80,80,80) or Color3.fromRGB(55,55,55)
        onToggle(enabled)
    end)
end

-- ================= FEATURES =================

-- WalkSpeed (ENFORCED)
Toggle("WalkSpeed", function(v)
    State.WalkSpeed = v
end)

-- JumpPower (ENFORCED)
Toggle("JumpPower", function(v)
    State.JumpPower = v
end)

-- Save Checkpoint
Button("Save Checkpoint", function()
    if State.Alive then
        State.SavedCFrame = hrp.CFrame
    end
end)

-- Teleport to Checkpoint (SAFE)
Button("Teleport to Checkpoint", function()
    if State.Alive and State.SavedCFrame then
        humanoid:ChangeState(Enum.HumanoidStateType.Physics)
        hrp.Velocity = Vector3.zero
        hrp.CFrame = State.SavedCFrame
        task.wait()
        humanoid:ChangeState(Enum.HumanoidStateType.Running)
    end
end)

-- FPS Boost
Button("FPS Boost", function()
    for _,v in ipairs(Lighting:GetChildren()) do
        if v:IsA("PostEffect") then
            v.Enabled = false
        end
    end
end)

-- Rejoin
Button("Rejoin Server", function()
    TeleportService:Teleport(game.PlaceId, player)
end)

-- ================= ENFORCE LOOP =================
RunService.Heartbeat:Connect(function()
    if State.Alive and humanoid then
        if State.WalkSpeed then
            humanoid.WalkSpeed = 32
        end
        if State.JumpPower then
            humanoid.JumpPower = 80
        end
    end
end)

-- Toggle UI
UIS.InputBegan:Connect(function(i,gp)
    if not gp and i.KeyCode == Enum.KeyCode.RightShift then
        gui.Enabled = not gui.Enabled
    end
end)

print("[Kqz Utility Hub] Loaded successfully")
