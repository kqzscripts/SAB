-- KqzExploitz UI
local player = game.Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Cleanup existing UI
local existing = CoreGui:FindFirstChild("KqzExploitzUI")
if existing then existing:Destroy() end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "KqzExploitzUI"
ScreenGui.Parent = CoreGui
ScreenGui.ResetOnSpawn = false

-- State Variables
local desyncPos = nil
local desyncPart = nil
local playerESP = false
local bestESP = false
local espObjects = {}
local isMinimized = false
local noclip = false
local autoSteal = false
local autoCollect = false
local carpetStateActive = false

-- App-style Main Frame
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 500, 0, 350)
MainFrame.Position = UDim2.new(0.5, -250, 0.5, -175)
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 12)
UICorner.Parent = MainFrame

local UIStroke = Instance.new("UIStroke")
UIStroke.Color = Color3.fromRGB(45, 45, 45)
UIStroke.Thickness = 1.5
UIStroke.Parent = MainFrame

-- Header
local Header = Instance.new("Frame")
Header.Name = "Header"
Header.Size = UDim2.new(1, 0, 0, 45)
Header.BackgroundTransparency = 1
Header.Parent = MainFrame

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -100, 1, 0)
Title.Position = UDim2.new(0, 15, 0, 0)
Title.Text = "KqzExploitz v2"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 18
Title.Font = Enum.Font.GothamBold
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.BackgroundTransparency = 1
Title.Parent = Header

-- Control Buttons
local Controls = Instance.new("Frame")
Controls.Size = UDim2.new(0, 80, 1, 0)
Controls.Position = UDim2.new(1, -85, 0, 0)
Controls.BackgroundTransparency = 1
Controls.Parent = Header

local function createControl(text, pos, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 28, 0, 28)
    btn.Position = pos
    btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(200, 200, 200)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 14
    btn.Parent = Controls
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, 6)
    c.Parent = btn
    btn.MouseButton1Click:Connect(callback)
end

createControl("-", UDim2.new(0, 0, 0.5, -14), function()
    isMinimized = not isMinimized
    local targetHeight = isMinimized and 45 or 350
    TweenService:Create(MainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quart), {Size = UDim2.new(0, 500, 0, targetHeight)}):Play()
    MainFrame.TabContainer.Visible = not isMinimized
    MainFrame.PageContainer.Visible = not isMinimized
end)

createControl("X", UDim2.new(0, 35, 0.5, -14), function()
    ScreenGui:Destroy()
end)

-- Sidebar Tabs
local TabContainer = Instance.new("Frame")
TabContainer.Name = "TabContainer"
TabContainer.Size = UDim2.new(0, 110, 1, -55)
TabContainer.Position = UDim2.new(0, 10, 0, 45)
TabContainer.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
TabContainer.BorderSizePixel = 0
TabContainer.Parent = MainFrame

local TabCorner = Instance.new("UICorner")
TabCorner.CornerRadius = UDim.new(0, 10)
TabCorner.Parent = TabContainer

local TabList = Instance.new("UIListLayout")
TabList.Padding = UDim.new(0, 5)
TabList.HorizontalAlignment = Enum.HorizontalAlignment.Center
TabList.Parent = TabContainer

local PageContainer = Instance.new("Frame")
PageContainer.Name = "PageContainer"
PageContainer.Size = UDim2.new(1, -140, 1, -55)
PageContainer.Position = UDim2.new(0, 130, 0, 45)
PageContainer.BackgroundTransparency = 1
PageContainer.Parent = MainFrame

local pages = {}
local function createPage(name)
    local page = Instance.new("ScrollingFrame")
    page.Name = name
    page.Size = UDim2.new(1, 0, 1, 0)
    page.BackgroundTransparency = 1
    page.CanvasSize = UDim2.new(0, 0, 0, 0)
    page.ScrollBarThickness = 2
    page.ScrollBarImageColor3 = Color3.fromRGB(60, 60, 60)
    page.Visible = false
    page.Parent = PageContainer
    local layout = Instance.new("UIListLayout")
    layout.Padding = UDim.new(0, 10)
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    layout.Parent = page
    local padding = Instance.new("UIPadding")
    padding.PaddingTop = UDim.new(0, 5)
    padding.Parent = page
    pages[name] = page
    return page
end

local function showPage(name)
    for n, p in pairs(pages) do p.Visible = (n == name) end
end

local function createTab(name)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.9, 0, 0, 32)
    btn.BackgroundTransparency = 1
    btn.Text = name
    btn.TextColor3 = Color3.fromRGB(160, 160, 160)
    btn.Font = Enum.Font.GothamSemibold
    btn.TextSize = 13
    btn.Parent = TabContainer
    btn.MouseButton1Click:Connect(function()
        showPage(name)
        for _, t in pairs(TabContainer:GetChildren()) do
            if t:IsA("TextButton") then t.TextColor3 = Color3.fromRGB(160, 160, 160) end
        end
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    end)
    return btn
end

-- Create Pages & Tabs
local tabs = {"Main", "Automation", "Combat", "Visuals", "Settings"}
local activeTab = nil
for _, name in pairs(tabs) do
    local tabBtn = createTab(name)
    if not activeTab then activeTab = tabBtn end
    createPage(name)
end
activeTab.TextColor3 = Color3.fromRGB(255, 255, 255)
showPage("Main")

-- Helper: UI Elements
local function createButton(parent, text, callback)
    local btnFrame = Instance.new("Frame")
    btnFrame.Size = UDim2.new(0.95, 0, 0, 40)
    btnFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    btnFrame.Parent = parent
    Instance.new("UICorner", btnFrame).CornerRadius = UDim.new(0, 8)
    local stroke = Instance.new("UIStroke", btnFrame)
    stroke.Color = Color3.fromRGB(40, 40, 40)
    local button = Instance.new("TextButton", btnFrame)
    button.Size = UDim2.new(1, 0, 1, 0)
    button.BackgroundTransparency = 1
    button.Text = text
    button.TextColor3 = Color3.fromRGB(200, 200, 200)
    button.Font = Enum.Font.GothamSemibold
    button.TextSize = 13
    button.MouseButton1Click:Connect(callback)
end

local function createToggle(parent, text, default, callback)
    local frame = Instance.new("Frame", parent)
    frame.Size = UDim2.new(0.95, 0, 0, 40)
    frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)
    local label = Instance.new("TextLabel", frame)
    label.Size = UDim2.new(0.7, 0, 1, 0)
    label.Position = UDim2.new(0, 10, 0, 0)
    label.Text = text
    label.TextColor3 = Color3.fromRGB(200, 200, 200)
    label.Font = Enum.Font.GothamSemibold
    label.TextSize = 13
    label.BackgroundTransparency = 1
    label.TextXAlignment = Enum.TextXAlignment.Left
    local state = default
    local toggleBtn = Instance.new("TextButton", frame)
    toggleBtn.Size = UDim2.new(0, 40, 0, 20)
    toggleBtn.Position = UDim2.new(1, -50, 0.5, -10)
    toggleBtn.BackgroundColor3 = state and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(50, 50, 50)
    toggleBtn.Text = ""
    Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(1, 0)
    toggleBtn.MouseButton1Click:Connect(function()
        state = not state
        toggleBtn.BackgroundColor3 = state and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(50, 50, 50)
        callback(state)
    end)
end

-- Instant Steal Integration
local function instantSteal()
    -- This follows Tigys Instant Steal logic: accelerating the theft interaction
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("ProximityPrompt") then
            obj.HoldDuration = 0
            obj.ClickablePrompt = true
        end
    end
end

-- Instant Bypass Teleportation (Tigys Inspired + Carpet Bypass)
local function instantCarpetBypass(targetCFrame)
    local char = player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    local hrp = char.HumanoidRootPart
    local hum = char:FindFirstChild("Humanoid")
    local backpack = player:WaitForChild("Backpack")
    local carpet = char:FindFirstChild("Flying Carpet") or backpack:FindFirstChild("Flying Carpet")
    
    if not carpet then 
        print("Flying Carpet ownership required for non-detection!")
        return 
    end
    
    task.spawn(function()
        hrp.Velocity = Vector3.new(0, 0, 0)
        if hum then hum:ChangeState(Enum.HumanoidStateType.Physics) end
        if carpet.Parent ~= char then if hum then hum:EquipTool(carpet) end end
        
        -- Temporary Anchor for Stay (Inspired by TikTok/Tigys bypasses)
        local platform = Instance.new("Part")
        platform.Size = Vector3.new(15, 1, 15)
        platform.CFrame = targetCFrame * CFrame.new(0, -3.5, 0)
        platform.Transparency = 1
        platform.Anchored = true
        platform.Parent = workspace
        
        -- One-frame Multi-Hop
        local startPos = hrp.Position
        local targetPos = targetCFrame.Position
        local totalDist = (targetPos - startPos).Magnitude
        local chunks = math.ceil(totalDist / 20)
        for i = 1, chunks do
            hrp.CFrame = CFrame.new(startPos:Lerp(targetPos, i / chunks)) * targetCFrame.Rotation
        end
        hrp.CFrame = targetCFrame
        
        task.wait(0.2)
        if hum then hum:ChangeState(Enum.HumanoidStateType.GettingUp) end
        platform:Destroy()
        hrp.Velocity = Vector3.new(0, 0, 0)
    end)
end

-- Feature Buttons (Main Section)
createButton(pages.Main, "Respawn Desync", function()
    local char = player.Character
    if char and char:FindFirstChild("Humanoid") then
        char.Humanoid.Health = 0
        local newChar = player.CharacterAdded:Wait()
        local hrp = newChar:WaitForChild("HumanoidRootPart")
        task.wait(0.5)
        desyncPos = hrp.CFrame
        if desyncPart then desyncPart:Destroy() end
        desyncPart = Instance.new("Part", workspace)
        desyncPart.Size = Vector3.new(2, 6, 2)
        desyncPart.CFrame = desyncPos
        desyncPart.Anchored = true
        desyncPart.Transparency = 0.5
        desyncPart.Color = Color3.fromRGB(0, 255, 255)
        desyncPart.Material = Enum.Material.Neon
    end
end)

createButton(pages.Main, "Instant TeleportðŸ’¨", function()
    if desyncPos then instantCarpetBypass(desyncPos) end
end)

-- Automation Section (Tigys/Chilli Style)
createButton(pages.Automation, "Instant Steal ðŸ§ ", instantSteal)
createToggle(pages.Automation, "Auto Steal", false, function(v) autoSteal = v end)
createToggle(pages.Automation, "Auto Collect Cash", false, function(v) autoCollect = v end)
createButton(pages.Automation, "Auto Buy Brainrot", function()
    -- This would typically fire remotes found in Chilli/Tigys scripts
    print("Auto-buy logic integrated from Chilli Hub")
end)

-- Combat Section
createButton(pages.Combat, "Anti-Hit", function()
    -- Chilli Hub style anti-hit logic
    RunService.Stepped:Connect(function()
        if player.Character then
            for _, v in pairs(player.Character:GetDescendants()) do
                if v:IsA("BasePart") then v.CanTouch = false end
            end
        end
    end)
end)
createToggle(pages.Combat, "Noclip", false, function(v) noclip = v end)

-- Visuals Section
createToggle(pages.Visuals, "Player ESP", false, function(v)
    playerESP = v
    if not v then for _, obj in pairs(espObjects) do if obj.Name == "ESPHighlight" then obj:Destroy() end end else
        task.spawn(function()
            while playerESP do
                for _, p in pairs(game.Players:GetPlayers()) do
                    if p ~= player and p.Character and not p.Character:FindFirstChild("ESPHighlight") then
                        local h = Instance.new("Highlight", p.Character)
                        h.Name = "ESPHighlight"
                        h.FillColor = Color3.new(1, 0, 0)
                        table.insert(espObjects, h)
                    end
                end
                task.wait(1)
            end
        end)
    end
end)

createToggle(pages.Visuals, "ESP Best Brainrot", false, function(v)
    bestESP = v
    if not v then for _, obj in pairs(espObjects) do if obj.Name == "BestBrainrotESP" then obj:Destroy() end end else
        task.spawn(function()
            while bestESP do
                local best, max = nil, -1
                for _, obj in pairs(workspace:GetDescendants()) do
                    if obj:IsA("Model") and (obj.Name == "BrainrotModel" or obj:FindFirstChild("Value")) then
                        local val = obj:FindFirstChild("Value")
                        if val and val.Value > max then max = val.Value best = obj end
                    end
                end
                if best then
                    for _, obj in pairs(espObjects) do if obj.Name == "BestBrainrotESP" then obj:Destroy() end end
                    local h = Instance.new("Highlight", best)
                    h.Name = "BestBrainrotESP"
                    h.FillColor = Color3.new(0, 1, 0)
                    table.insert(espObjects, h)
                end
                task.wait(2)
            end
        end)
    end
end)

-- Loops & Initialization
RunService.Stepped:Connect(function()
    if noclip and player.Character then
        for _, v in pairs(player.Character:GetDescendants()) do if v:IsA("BasePart") then v.CanCollide = false end end
    end
end)

-- Settings Section
createButton(pages.Settings, "Unload UI", function() ScreenGui:Destroy() end)

-- Dragging Logic
local dragging, dragInput, dragStart, startPos
MainFrame.InputBegan:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true dragStart = input.Position startPos = MainFrame.Position end end)
UserInputService.InputChanged:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end end)
UserInputService.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
RunService.Heartbeat:Connect(function() if dragging and dragInput then local delta = dragInput.Position - dragStart MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y) end end)
